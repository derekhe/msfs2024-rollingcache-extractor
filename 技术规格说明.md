# MSFS2024 RollingCache æŠ€æœ¯è§„æ ¼è¯´æ˜ - æœ€ç»ˆç‰ˆ

## ğŸ“‹ é¡¹ç›®æ€»ç»“

### æœ€ç»ˆæˆæœ
| æŒ‡æ ‡ | ç»“æœ |
|------|------|
| æˆåŠŸæå–å›¾åƒ | 4196å¼  |
| å›¾åƒæ ¼å¼ | JPEG |
| å›¾åƒå°ºå¯¸ | 256x256 åƒç´  |
| æ–‡ä»¶å¤§å°èŒƒå›´ | 834 - 66,782 å­—èŠ‚ |
| å¹³å‡æ–‡ä»¶å¤§å° | 50,681 å­—èŠ‚ |
| æ€»å¤§å° | ~200 MB |
| å¤„ç†æ—¶é—´ | ~12 ç§’ |
| å·¥å…·ç®€åŒ– | ç§»é™¤è´¨é‡åˆ†ç±»ï¼Œå•ç›®å½•è¾“å‡º |

### æ–‡ä»¶å¤´ç»“æ„ (48å­—èŠ‚)
```c
struct RollingCacheHeader {
    uint32_t magic;          // 0x00: Magic number (0x12)
    uint32_t header_size;    // 0x04: Header size (48)
    uint32_t version;        // 0x08: File version
    uint32_t block_size;     // 0x0C: Block size (1MB)
    uint32_t block_count;    // 0x10: Total blocks
    uint32_t used_blocks;    // 0x14: Used blocks
    uint32_t checksum1;      // 0x18: Primary checksum
    uint32_t checksum2;      // 0x1C: Secondary checksum
    uint64_t reserved;       // 0x20: Reserved field
    uint64_t timestamp;      // 0x28: Creation timestamp
};
```

## ğŸ—‚ï¸ å­˜å‚¨å¸ƒå±€

### å—ç»„ç»‡ç»“æ„
```
åœ°å€å¸ƒå±€ (æ¯4MBä¸ºä¸€ç»„):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®å— (1MB)   â”‚   ç©ºéš™ (1MB)    â”‚   ç©ºéš™ (1MB)    â”‚   ç©ºéš™ (1MB)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 0x000000-0x0FFFFF 0x100000-0x1FFFFF 0x200000-0x2FFFFF 0x300000-0x3FFFFF

ä¸‹ä¸€ç»„ä» 0x400000 å¼€å§‹...
```

### åœ°å€è®¡ç®—å…¬å¼
```python
# æ•°æ®å—èµ·å§‹åœ°å€
data_block_address = block_index * 0x400000

## ğŸ“‹ æ–‡ä»¶æ ¼å¼è§„æ ¼

### åŸºç¡€ä¿¡æ¯
| å±æ€§ | å€¼ |
|------|-----|
| æ–‡ä»¶æ ¼å¼ | MSFS2024 RollingCache |
| æ–‡ä»¶æ‰©å±•å | .CCC |
| Magic Number | 0x00000012 |
| å­—èŠ‚åº | Little Endian |
| æœ€å¤§æ–‡ä»¶å¤§å° | 16 GB |

### æ–‡ä»¶å¤´ç»“æ„ (48å­—èŠ‚)
```c
struct RollingCacheHeader {
    uint32_t magic;          // 0x00: Magic number (0x12)
    uint32_t header_size;    // 0x04: Header size (48)
    uint32_t version;        // 0x08: File version
    uint32_t block_size;     // 0x0C: Block size (1MB)
    uint32_t block_count;    // 0x10: Total blocks
    uint32_t used_blocks;    // 0x14: Used blocks
    uint32_t checksum1;      // 0x18: Primary checksum
    uint32_t checksum2;      // 0x1C: Secondary checksum
    uint64_t reserved;       // 0x20: Reserved field
    uint64_t timestamp;      // 0x28: Creation timestamp
};
```

## ğŸ—‚ï¸ å­˜å‚¨å¸ƒå±€

### å—ç»„ç»‡ç»“æ„
```
åœ°å€å¸ƒå±€ (æ¯4MBä¸ºä¸€ç»„):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®å— (1MB)   â”‚   ç©ºéš™ (1MB)    â”‚   ç©ºéš™ (1MB)    â”‚   ç©ºéš™ (1MB)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 0x000000-0x0FFFFF 0x100000-0x1FFFFF 0x200000-0x2FFFFF 0x300000-0x3FFFFF

ä¸‹ä¸€ç»„ä» 0x400000 å¼€å§‹...
```

### åœ°å€è®¡ç®—å…¬å¼
```python
# æ•°æ®å—èµ·å§‹åœ°å€
data_block_address = block_index * 0x400000

# æ•°æ®æœ‰æ•ˆèŒƒå›´  
data_start = data_block_address
data_end = data_block_address + 0x100000  # 1MB
```

## ğŸ–¼ï¸ å›¾åƒæ•°æ®è§„æ ¼

### JPEGå›¾åƒè§„æ ¼
| å±æ€§ | è§„æ ¼ |
|------|------|
| æ ¼å¼ | JPEG/JFIF |
| å°ºå¯¸ | 256x256 åƒç´  |
| è‰²å½©ç©ºé—´ | YUV (4:2:0) |
| æ–‡ä»¶ç­¾å | `FF D8 FF` |
| ç»“æŸæ ‡è®° | `FF D9` (å¯é€‰) |
| å¹³å‡å¤§å° | 50 KB |
| å¤§å°èŒƒå›´ | 800B - 67KB |

### BCå‹ç¼©çº¹ç†è§„æ ¼
| å±æ€§ | BC1/DXT1 | BC3/DXT5 |
|------|----------|----------|
| å—å¤§å° | 4x4 åƒç´  | 4x4 åƒç´  |
| æ•°æ®å¤§å° | 8 å­—èŠ‚/å— | 16 å­—èŠ‚/å— |
| Alphaæ”¯æŒ | 1ä½ | 8ä½ |
| å‹ç¼©æ¯” | 6:1 | 4:1 |

## ğŸ” æ£€æµ‹ç®—æ³•

### JPEGæ£€æµ‹æµç¨‹
```python
def detect_jpeg_image(data, offset):
    # 1. æ£€æŸ¥JPEGç­¾å
    if data[offset:offset+3] != b'\xFF\xD8\xFF':
        return False
    
    # 2. æœç´¢SOFæ ‡è®°
    for i in range(offset+3, offset+2048):
        if data[i] == 0xFF and data[i+1] in [0xC0, 0xC1, 0xC2, 0xC3]:
            # 3. è§£æå›¾åƒå°ºå¯¸
            height = struct.unpack('>H', data[i+5:i+7])[0]
            width = struct.unpack('>H', data[i+7:i+9])[0]
            
            # 4. éªŒè¯å°ºå¯¸ (256Â±20)
            if 240 <= width <= 280 and 240 <= height <= 280:
                return True
    
    return False
```

## ğŸ› ï¸ ç®€åŒ–å·¥å…·è®¾è®¡

### è®¾è®¡åŸåˆ™
- **ä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½**: ç§»é™¤å¤æ‚çš„è´¨é‡åˆ†ç±»
- **ç®€åŒ–è¾“å‡º**: æ‰€æœ‰å›¾åƒä¿å­˜åœ¨å•ä¸€ç›®å½•
- **æ¸…æ™°å‘½å**: `satellite_åºå·_å°ºå¯¸_åœ°å€.jpg`
- **é«˜æ•ˆå¤„ç†**: å†…å­˜æ˜ å°„ + æ™ºèƒ½æœç´¢
    elif bytes_per_pixel > 1.5: return "High"  
    elif bytes_per_pixel > 1.0: return "Medium"
    elif bytes_per_pixel > 0.5: return "Low"
    else:                       return "Very Low"
```

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### æœç´¢æ€§èƒ½
| æŒ‡æ ‡ | å€¼ |
|------|-----|
| æ–‡ä»¶å¤§å° | 16 GB |
| æœç´¢æ—¶é—´ | ~12 ç§’ |
| æœç´¢é€Ÿåº¦ | ~1.3 GB/ç§’ |
| å†…å­˜ä½¿ç”¨ | ~100 MB |

### æå–æ€§èƒ½  
| æŒ‡æ ‡ | å€¼ |
|------|-----|
| å›¾åƒæ•°é‡ | 4,196 ä¸ª |
| æå–æ—¶é—´ | ~20 ç§’ |
| æå–é€Ÿåº¦ | ~210 å›¾åƒ/ç§’ |
| è¾“å‡ºå¤§å° | 203 MB |

## ğŸ”§ å®ç°ç»†èŠ‚

### å†…å­˜æ˜ å°„ä¼˜åŒ–
```python
import mmap

# ä½¿ç”¨å†…å­˜æ˜ å°„é¿å…å¤§æ–‡ä»¶åŠ è½½
with open(filename, 'rb') as f:
    with mmap.mmap(f.fileno(), 0, access=mmap.ACCESS_READ) as mm:
        # é«˜æ•ˆçš„éšæœºè®¿é—®
        data = mm[offset:offset+size]
```

### ç¨€ç–åŒºåŸŸè·³è¿‡
```python
def skip_sparse_regions(mm, pos):
    """è·³è¿‡ç¨€ç–åŒºåŸŸæé«˜æœç´¢æ•ˆç‡"""
    current_block = pos // 0x400000
    block_start = current_block * 0x400000
    data_end = block_start + 0x100000
    
    if pos >= data_end:
        # è·³åˆ°ä¸‹ä¸€ä¸ªæ•°æ®å—
        return (current_block + 1) * 0x400000
    
    return pos
```

## ğŸ“Š ç»Ÿè®¡æ•°æ®

### å…¸å‹æ–‡ä»¶ç»Ÿè®¡
```
æ–‡ä»¶: ROLLINGCACHE-more-content.CCC
å¤§å°: 16,777,216 KB (16.0 GB)
æ•°æ®å—: 4,096 ä¸ª (æ¯ä¸ª1MB)
ä½¿ç”¨ç‡: ~25% (æœ‰æ•ˆæ•°æ®çº¦4GB)

å›¾åƒç»Ÿè®¡:
â”œâ”€â”€ JPEGå›¾åƒ: 4,196 ä¸ª
â”œâ”€â”€ BCçº¹ç†: ~2,000 ä¸ª  
â”œâ”€â”€ å¹³å‡è´¨é‡: Low (91.4%)
â””â”€â”€ æ€»æå–é‡: 202.8 MB
```

### è´¨é‡åˆ†å¸ƒ
```
è´¨é‡ç­‰çº§     æ•°é‡    ç™¾åˆ†æ¯”    å¹³å‡å¤§å°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Very High      0     0.0%        -
High           0     0.0%        -  
Medium         3     0.1%     78 KB
Low        3,834    91.4%     53 KB
Very Low     359     8.6%     25 KB
```

## ğŸ›¡ï¸ å®Œæ•´æ€§éªŒè¯

### æ ¡éªŒå’ŒéªŒè¯
```python
def verify_checksum(header_data):
    """éªŒè¯æ–‡ä»¶å®Œæ•´æ€§"""
    checksum1 = struct.unpack('<I', header_data[0x18:0x1C])[0]
    checksum2 = struct.unpack('<I', header_data[0x1C:0x20])[0]
    
    # å®ç°å…·ä½“çš„æ ¡éªŒå’Œç®—æ³•
    calculated_checksum = calculate_checksum(header_data)
    
    return checksum1 == calculated_checksum
```

### æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
```python
def validate_extracted_image(image_path):
    """éªŒè¯æå–çš„å›¾åƒå®Œæ•´æ€§"""
    try:
        from PIL import Image
        with Image.open(image_path) as img:
            img.verify()  # éªŒè¯å›¾åƒæ ¼å¼
            return img.size == (256, 256)
    except Exception:
        return False
```

## ï¿½ æœ€ç»ˆæå–ç»Ÿè®¡

### å¤„ç†æ€§èƒ½
```
æ–‡ä»¶å¤§å°: 16 GB (ç¨€ç–å­˜å‚¨)
æœ‰æ•ˆæ•°æ®: ~4 GB (25% ä½¿ç”¨ç‡)  
æ•°æ®å—: 4,096 ä¸ª (æ¯ä¸ª1MB)
å¤„ç†æ—¶é—´: 11.56 ç§’

å›¾åƒç»Ÿè®¡:
â”œâ”€â”€ JPEGå›¾åƒ: 4,196 ä¸ª
â”œâ”€â”€ å›¾åƒå°ºå¯¸: 256x256 åƒç´ 
â”œâ”€â”€ æ–‡ä»¶å¤§å°: 834B - 66,782B
â”œâ”€â”€ å¹³å‡å¤§å°: 50,681 å­—èŠ‚
â””â”€â”€ æ€»æå–é‡: ~200 MB
```

### ç®€åŒ–è¾“å‡ºç»“æ„
```
extracted_jpegs/
â”œâ”€â”€ satellite_0001_256x256_0x1a2b3c4d.jpg
â”œâ”€â”€ satellite_0002_256x256_0x2b3c4d5e.jpg
â”œâ”€â”€ satellite_0003_256x256_0x3c4d5e6f.jpg
â””â”€â”€ ... (å…±4196å¼ å›¾åƒï¼Œå•ä¸€ç›®å½•)
```

## ï¿½ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§

| MSFSç‰ˆæœ¬ | ç¼“å­˜æ ¼å¼ç‰ˆæœ¬ | å…¼å®¹æ€§ | å¤‡æ³¨ |
|----------|-------------|--------|------|
| MSFS2024 | v1.0 | âœ… å®Œå…¨æ”¯æŒ | æ ‡å‡†æ ¼å¼ |
| MSFS2020 | v0.9 | âš ï¸ éƒ¨åˆ†æ”¯æŒ | å¤´éƒ¨ç»“æ„ç•¥æœ‰ä¸åŒ |
| æœªæ¥ç‰ˆæœ¬ | v1.1+ | ğŸ” éœ€è¦æµ‹è¯• | å¯èƒ½éœ€è¦é€‚é… |

## ğŸ“ ä½¿ç”¨è®¸å¯

æœ¬æ–‡æ¡£æè¿°çš„æ–‡ä»¶æ ¼å¼åˆ†æå’Œæå–æ–¹æ³•ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ç›®çš„ã€‚æå–çš„å›¾åƒå†…å®¹ç‰ˆæƒå½’Microsoft Corporationæ‰€æœ‰ã€‚è¯·éµå®ˆç›¸å…³è½¯ä»¶è®¸å¯åè®®å’Œæ³•å¾‹æ³•è§„ã€‚
