# MSFS2024 RollingCache 技术规格说明 - 最终版

## 📋 项目总结

### 最终成果
| 指标 | 结果 |
|------|------|
| 成功提取图像 | 4196张 |
| 图像格式 | JPEG |
| 图像尺寸 | 256x256 像素 |
| 文件大小范围 | 834 - 66,782 字节 |
| 平均文件大小 | 50,681 字节 |
| 总大小 | ~200 MB |
| 处理时间 | ~12 秒 |
| 工具简化 | 移除质量分类，单目录输出 |

### 文件头结构 (48字节)
```c
struct RollingCacheHeader {
    uint32_t magic;          // 0x00: Magic number (0x12)
    uint32_t header_size;    // 0x04: Header size (48)
    uint32_t version;        // 0x08: File version
    uint32_t block_size;     // 0x0C: Block size (1MB)
    uint32_t block_count;    // 0x10: Total blocks
    uint32_t used_blocks;    // 0x14: Used blocks
    uint32_t checksum1;      // 0x18: Primary checksum
    uint32_t checksum2;      // 0x1C: Secondary checksum
    uint64_t reserved;       // 0x20: Reserved field
    uint64_t timestamp;      // 0x28: Creation timestamp
};
```

## 🗂️ 存储布局

### 块组织结构
```
地址布局 (每4MB为一组):
┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐
│   数据块 (1MB)   │   空隙 (1MB)    │   空隙 (1MB)    │   空隙 (1MB)    │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
 0x000000-0x0FFFFF 0x100000-0x1FFFFF 0x200000-0x2FFFFF 0x300000-0x3FFFFF

下一组从 0x400000 开始...
```

### 地址计算公式
```python
# 数据块起始地址
data_block_address = block_index * 0x400000

## 📋 文件格式规格

### 基础信息
| 属性 | 值 |
|------|-----|
| 文件格式 | MSFS2024 RollingCache |
| 文件扩展名 | .CCC |
| Magic Number | 0x00000012 |
| 字节序 | Little Endian |
| 最大文件大小 | 16 GB |

### 文件头结构 (48字节)
```c
struct RollingCacheHeader {
    uint32_t magic;          // 0x00: Magic number (0x12)
    uint32_t header_size;    // 0x04: Header size (48)
    uint32_t version;        // 0x08: File version
    uint32_t block_size;     // 0x0C: Block size (1MB)
    uint32_t block_count;    // 0x10: Total blocks
    uint32_t used_blocks;    // 0x14: Used blocks
    uint32_t checksum1;      // 0x18: Primary checksum
    uint32_t checksum2;      // 0x1C: Secondary checksum
    uint64_t reserved;       // 0x20: Reserved field
    uint64_t timestamp;      // 0x28: Creation timestamp
};
```

## 🗂️ 存储布局

### 块组织结构
```
地址布局 (每4MB为一组):
┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐
│   数据块 (1MB)   │   空隙 (1MB)    │   空隙 (1MB)    │   空隙 (1MB)    │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
 0x000000-0x0FFFFF 0x100000-0x1FFFFF 0x200000-0x2FFFFF 0x300000-0x3FFFFF

下一组从 0x400000 开始...
```

### 地址计算公式
```python
# 数据块起始地址
data_block_address = block_index * 0x400000

# 数据有效范围  
data_start = data_block_address
data_end = data_block_address + 0x100000  # 1MB
```

## 🖼️ 图像数据规格

### JPEG图像规格
| 属性 | 规格 |
|------|------|
| 格式 | JPEG/JFIF |
| 尺寸 | 256x256 像素 |
| 色彩空间 | YUV (4:2:0) |
| 文件签名 | `FF D8 FF` |
| 结束标记 | `FF D9` (可选) |
| 平均大小 | 50 KB |
| 大小范围 | 800B - 67KB |

### BC压缩纹理规格
| 属性 | BC1/DXT1 | BC3/DXT5 |
|------|----------|----------|
| 块大小 | 4x4 像素 | 4x4 像素 |
| 数据大小 | 8 字节/块 | 16 字节/块 |
| Alpha支持 | 1位 | 8位 |
| 压缩比 | 6:1 | 4:1 |

## 🔍 检测算法

### JPEG检测流程
```python
def detect_jpeg_image(data, offset):
    # 1. 检查JPEG签名
    if data[offset:offset+3] != b'\xFF\xD8\xFF':
        return False
    
    # 2. 搜索SOF标记
    for i in range(offset+3, offset+2048):
        if data[i] == 0xFF and data[i+1] in [0xC0, 0xC1, 0xC2, 0xC3]:
            # 3. 解析图像尺寸
            height = struct.unpack('>H', data[i+5:i+7])[0]
            width = struct.unpack('>H', data[i+7:i+9])[0]
            
            # 4. 验证尺寸 (256±20)
            if 240 <= width <= 280 and 240 <= height <= 280:
                return True
    
    return False
```

## 🛠️ 简化工具设计

### 设计原则
- **专注核心功能**: 移除复杂的质量分类
- **简化输出**: 所有图像保存在单一目录
- **清晰命名**: `satellite_序号_尺寸_地址.jpg`
- **高效处理**: 内存映射 + 智能搜索
    elif bytes_per_pixel > 1.5: return "High"  
    elif bytes_per_pixel > 1.0: return "Medium"
    elif bytes_per_pixel > 0.5: return "Low"
    else:                       return "Very Low"
```

## 📈 性能指标

### 搜索性能
| 指标 | 值 |
|------|-----|
| 文件大小 | 16 GB |
| 搜索时间 | ~12 秒 |
| 搜索速度 | ~1.3 GB/秒 |
| 内存使用 | ~100 MB |

### 提取性能  
| 指标 | 值 |
|------|-----|
| 图像数量 | 4,196 个 |
| 提取时间 | ~20 秒 |
| 提取速度 | ~210 图像/秒 |
| 输出大小 | 203 MB |

## 🔧 实现细节

### 内存映射优化
```python
import mmap

# 使用内存映射避免大文件加载
with open(filename, 'rb') as f:
    with mmap.mmap(f.fileno(), 0, access=mmap.ACCESS_READ) as mm:
        # 高效的随机访问
        data = mm[offset:offset+size]
```

### 稀疏区域跳过
```python
def skip_sparse_regions(mm, pos):
    """跳过稀疏区域提高搜索效率"""
    current_block = pos // 0x400000
    block_start = current_block * 0x400000
    data_end = block_start + 0x100000
    
    if pos >= data_end:
        # 跳到下一个数据块
        return (current_block + 1) * 0x400000
    
    return pos
```

## 📊 统计数据

### 典型文件统计
```
文件: ROLLINGCACHE-more-content.CCC
大小: 16,777,216 KB (16.0 GB)
数据块: 4,096 个 (每个1MB)
使用率: ~25% (有效数据约4GB)

图像统计:
├── JPEG图像: 4,196 个
├── BC纹理: ~2,000 个  
├── 平均质量: Low (91.4%)
└── 总提取量: 202.8 MB
```

### 质量分布
```
质量等级     数量    百分比    平均大小
──────────────────────────────────────
Very High      0     0.0%        -
High           0     0.0%        -  
Medium         3     0.1%     78 KB
Low        3,834    91.4%     53 KB
Very Low     359     8.6%     25 KB
```

## 🛡️ 完整性验证

### 校验和验证
```python
def verify_checksum(header_data):
    """验证文件完整性"""
    checksum1 = struct.unpack('<I', header_data[0x18:0x1C])[0]
    checksum2 = struct.unpack('<I', header_data[0x1C:0x20])[0]
    
    # 实现具体的校验和算法
    calculated_checksum = calculate_checksum(header_data)
    
    return checksum1 == calculated_checksum
```

### 数据完整性检查
```python
def validate_extracted_image(image_path):
    """验证提取的图像完整性"""
    try:
        from PIL import Image
        with Image.open(image_path) as img:
            img.verify()  # 验证图像格式
            return img.size == (256, 256)
    except Exception:
        return False
```

## � 最终提取统计

### 处理性能
```
文件大小: 16 GB (稀疏存储)
有效数据: ~4 GB (25% 使用率)  
数据块: 4,096 个 (每个1MB)
处理时间: 11.56 秒

图像统计:
├── JPEG图像: 4,196 个
├── 图像尺寸: 256x256 像素
├── 文件大小: 834B - 66,782B
├── 平均大小: 50,681 字节
└── 总提取量: ~200 MB
```

### 简化输出结构
```
extracted_jpegs/
├── satellite_0001_256x256_0x1a2b3c4d.jpg
├── satellite_0002_256x256_0x2b3c4d5e.jpg
├── satellite_0003_256x256_0x3c4d5e6f.jpg
└── ... (共4196张图像，单一目录)
```

## �🔄 版本兼容性

| MSFS版本 | 缓存格式版本 | 兼容性 | 备注 |
|----------|-------------|--------|------|
| MSFS2024 | v1.0 | ✅ 完全支持 | 标准格式 |
| MSFS2020 | v0.9 | ⚠️ 部分支持 | 头部结构略有不同 |
| 未来版本 | v1.1+ | 🔍 需要测试 | 可能需要适配 |

## 📝 使用许可

本文档描述的文件格式分析和提取方法仅供学习和研究目的。提取的图像内容版权归Microsoft Corporation所有。请遵守相关软件许可协议和法律法规。
